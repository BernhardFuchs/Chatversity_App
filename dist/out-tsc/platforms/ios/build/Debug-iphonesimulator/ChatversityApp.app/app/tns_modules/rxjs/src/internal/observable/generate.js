"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Observable_1 = require("../Observable");
var identity_1 = require("../util/identity");
var isScheduler_1 = require("../util/isScheduler");
function generate(initialStateOrOptions, condition, iterate, resultSelectorOrObservable, scheduler) {
    var resultSelector;
    var initialState;
    if (arguments.length == 1) {
        var options = initialStateOrOptions;
        initialState = options.initialState;
        condition = options.condition;
        iterate = options.iterate;
        resultSelector = options.resultSelector || identity_1.identity;
        scheduler = options.scheduler;
    }
    else if (resultSelectorOrObservable === undefined || isScheduler_1.isScheduler(resultSelectorOrObservable)) {
        initialState = initialStateOrOptions;
        resultSelector = identity_1.identity;
        scheduler = resultSelectorOrObservable;
    }
    else {
        initialState = initialStateOrOptions;
        resultSelector = resultSelectorOrObservable;
    }
    return new Observable_1.Observable(function (subscriber) {
        var state = initialState;
        if (scheduler) {
            return scheduler.schedule(dispatch, 0, {
                subscriber: subscriber,
                iterate: iterate,
                condition: condition,
                resultSelector: resultSelector,
                state: state
            });
        }
        do {
            if (condition) {
                var conditionResult = void 0;
                try {
                    conditionResult = condition(state);
                }
                catch (err) {
                    subscriber.error(err);
                    return undefined;
                }
                if (!conditionResult) {
                    subscriber.complete();
                    break;
                }
            }
            var value = void 0;
            try {
                value = resultSelector(state);
            }
            catch (err) {
                subscriber.error(err);
                return undefined;
            }
            subscriber.next(value);
            if (subscriber.closed) {
                break;
            }
            try {
                state = iterate(state);
            }
            catch (err) {
                subscriber.error(err);
                return undefined;
            }
        } while (true);
        return undefined;
    });
}
exports.generate = generate;
function dispatch(state) {
    var subscriber = state.subscriber, condition = state.condition;
    if (subscriber.closed) {
        return undefined;
    }
    if (state.needIterate) {
        try {
            state.state = state.iterate(state.state);
        }
        catch (err) {
            subscriber.error(err);
            return undefined;
        }
    }
    else {
        state.needIterate = true;
    }
    if (condition) {
        var conditionResult = void 0;
        try {
            conditionResult = condition(state.state);
        }
        catch (err) {
            subscriber.error(err);
            return undefined;
        }
        if (!conditionResult) {
            subscriber.complete();
            return undefined;
        }
        if (subscriber.closed) {
            return undefined;
        }
    }
    var value;
    try {
        value = state.resultSelector(state.state);
    }
    catch (err) {
        subscriber.error(err);
        return undefined;
    }
    if (subscriber.closed) {
        return undefined;
    }
    subscriber.next(value);
    if (subscriber.closed) {
        return undefined;
    }
    return this.schedule(state);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wbGF0Zm9ybXMvaW9zL2J1aWxkL0RlYnVnLWlwaG9uZXNpbXVsYXRvci9DaGF0dmVyc2l0eUFwcC5hcHAvYXBwL3Ruc19tb2R1bGVzL3J4anMvc3JjL2ludGVybmFsL29ic2VydmFibGUvZ2VuZXJhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw0Q0FBMkM7QUFFM0MsNkNBQTRDO0FBRTVDLG1EQUFrRDtBQThQbEQsU0FBZ0IsUUFBUSxDQUFPLHFCQUFnRCxFQUNoRCxTQUE0QixFQUM1QixPQUF3QixFQUN4QiwwQkFBK0QsRUFDL0QsU0FBeUI7SUFFdEQsSUFBSSxjQUFnQyxDQUFDO0lBQ3JDLElBQUksWUFBZSxDQUFDO0lBRXBCLElBQUksU0FBUyxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7UUFDekIsSUFBTSxPQUFPLEdBQUcscUJBQThDLENBQUM7UUFDL0QsWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDcEMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7UUFDOUIsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDMUIsY0FBYyxHQUFHLE9BQU8sQ0FBQyxjQUFjLElBQUksbUJBQTRCLENBQUM7UUFDeEUsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7S0FDL0I7U0FBTSxJQUFJLDBCQUEwQixLQUFLLFNBQVMsSUFBSSx5QkFBVyxDQUFDLDBCQUEwQixDQUFDLEVBQUU7UUFDOUYsWUFBWSxHQUFHLHFCQUEwQixDQUFDO1FBQzFDLGNBQWMsR0FBRyxtQkFBNEIsQ0FBQztRQUM5QyxTQUFTLEdBQUcsMEJBQTJDLENBQUM7S0FDekQ7U0FBTTtRQUNMLFlBQVksR0FBRyxxQkFBMEIsQ0FBQztRQUMxQyxjQUFjLEdBQUcsMEJBQThDLENBQUM7S0FDakU7SUFFRCxP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QUFDLEtBQUssQ0FBQyxDQUFDO0tBQzNDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBQ0QsSUFBSSxVQUFVLENBQUMsTUFBTSxFQUFFO1FBQ3JCLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBQ0QsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixJQUFJLFVBQVUsQ0FBQyxNQUFNLEVBQUU7UUFDckIsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFN1YnNjcmliZXIgfSBmcm9tICcuLi9TdWJzY3JpYmVyJztcbmltcG9ydCB7IGlkZW50aXR5IH0gZnJvbSAnLi4vdXRpbC9pZGVudGl0eSc7XG5pbXBvcnQgeyBTY2hlZHVsZXJBY3Rpb24sIFNjaGVkdWxlckxpa2UgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBpc1NjaGVkdWxlciB9IGZyb20gJy4uL3V0aWwvaXNTY2hlZHVsZXInO1xuXG5leHBvcnQgdHlwZSBDb25kaXRpb25GdW5jPFM+ID0gKHN0YXRlOiBTKSA9PiBib29sZWFuO1xuZXhwb3J0IHR5cGUgSXRlcmF0ZUZ1bmM8Uz4gPSAoc3RhdGU6IFMpID0+IFM7XG5leHBvcnQgdHlwZSBSZXN1bHRGdW5jPFMsIFQ+ID0gKHN0YXRlOiBTKSA9PiBUO1xuXG5pbnRlcmZhY2UgU2NoZWR1bGVyU3RhdGU8VCwgUz4ge1xuICBuZWVkSXRlcmF0ZT86IGJvb2xlYW47XG4gIHN0YXRlOiBTO1xuICBzdWJzY3JpYmVyOiBTdWJzY3JpYmVyPFQ+O1xuICBjb25kaXRpb24/OiBDb25kaXRpb25GdW5jPFM+O1xuICBpdGVyYXRlOiBJdGVyYXRlRnVuYzxTPjtcbiAgcmVzdWx0U2VsZWN0b3I6IFJlc3VsdEZ1bmM8UywgVD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJhdGVCYXNlT3B0aW9uczxTPiB7XG4gIC8qKlxuICAgKiBJbml0aWFsIHN0YXRlLlxuICAgKi9cbiAgaW5pdGlhbFN0YXRlOiBTO1xuICAvKipcbiAgICogQ29uZGl0aW9uIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBzdGF0ZSBhbmQgcmV0dXJucyBib29sZWFuLlxuICAgKiBXaGVuIGl0IHJldHVybnMgZmFsc2UsIHRoZSBnZW5lcmF0b3Igc3RvcHMuXG4gICAqIElmIG5vdCBzcGVjaWZpZWQsIGEgZ2VuZXJhdG9yIG5ldmVyIHN0b3BzLlxuICAgKi9cbiAgY29uZGl0aW9uPzogQ29uZGl0aW9uRnVuYzxTPjtcbiAgLyoqXG4gICAqIEl0ZXJhdGUgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHN0YXRlIGFuZCByZXR1cm5zIG5ldyBzdGF0ZS5cbiAgICovXG4gIGl0ZXJhdGU6IEl0ZXJhdGVGdW5jPFM+O1xuICAvKipcbiAgICogU2NoZWR1bGVyTGlrZSB0byB1c2UgZm9yIGdlbmVyYXRpb24gcHJvY2Vzcy5cbiAgICogQnkgZGVmYXVsdCwgYSBnZW5lcmF0b3Igc3RhcnRzIGltbWVkaWF0ZWx5LlxuICAgKi9cbiAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZW5lcmF0ZU9wdGlvbnM8VCwgUz4gZXh0ZW5kcyBHZW5lcmF0ZUJhc2VPcHRpb25zPFM+IHtcbiAgLyoqXG4gICAqIFJlc3VsdCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHN0YXRlIGFuZCByZXR1cm5zIGEgdmFsdWUgdG8gZW1pdC5cbiAgICovXG4gIHJlc3VsdFNlbGVjdG9yOiBSZXN1bHRGdW5jPFMsIFQ+O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlcyBhbiBvYnNlcnZhYmxlIHNlcXVlbmNlIGJ5IHJ1bm5pbmcgYSBzdGF0ZS1kcml2ZW4gbG9vcFxuICogcHJvZHVjaW5nIHRoZSBzZXF1ZW5jZSdzIGVsZW1lbnRzLCB1c2luZyB0aGUgc3BlY2lmaWVkIHNjaGVkdWxlclxuICogdG8gc2VuZCBvdXQgb2JzZXJ2ZXIgbWVzc2FnZXMuXG4gKlxuICogIVtdKGdlbmVyYXRlLnBuZylcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Qcm9kdWNlcyBzZXF1ZW5jZSBvZiAwLCAxLCAyLCAuLi4gOSwgdGhlbiBjb21wbGV0ZXMuPC9jYXB0aW9uPlxuICogY29uc3QgcmVzID0gZ2VuZXJhdGUoMCwgeCA9PiB4IDwgMTAsIHggPT4geCArIDEsIHggPT4geCk7XG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+VXNpbmcgYXNhcCBzY2hlZHVsZXIsIHByb2R1Y2VzIHNlcXVlbmNlIG9mIDIsIDMsIDUsIHRoZW4gY29tcGxldGVzLjwvY2FwdGlvbj5cbiAqIGNvbnN0IHJlcyA9IGdlbmVyYXRlKDEsIHggPT4geCA8IDUsIHggPT4gICogMiwgeCA9PiB4ICsgMSwgYXNhcCk7XG4gKlxuICogQHNlZSB7QGxpbmsgZnJvbX1cbiAqIEBzZWUge0BsaW5rIE9ic2VydmFibGV9XG4gKlxuICogQHBhcmFtIHtTfSBpbml0aWFsU3RhdGUgSW5pdGlhbCBzdGF0ZS5cbiAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogYm9vbGVhbn0gY29uZGl0aW9uIENvbmRpdGlvbiB0byB0ZXJtaW5hdGUgZ2VuZXJhdGlvbiAodXBvbiByZXR1cm5pbmcgZmFsc2UpLlxuICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBTfSBpdGVyYXRlIEl0ZXJhdGlvbiBzdGVwIGZ1bmN0aW9uLlxuICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBUfSByZXN1bHRTZWxlY3RvciBTZWxlY3RvciBmdW5jdGlvbiBmb3IgcmVzdWx0cyBwcm9kdWNlZCBpbiB0aGUgc2VxdWVuY2UuIChkZXByZWNhdGVkKVxuICogQHBhcmFtIHtTY2hlZHVsZXJMaWtlfSBbc2NoZWR1bGVyXSBBIHtAbGluayBTY2hlZHVsZXJMaWtlfSBvbiB3aGljaCB0byBydW4gdGhlIGdlbmVyYXRvciBsb29wLiBJZiBub3QgcHJvdmlkZWQsIGRlZmF1bHRzIHRvIGVtaXQgaW1tZWRpYXRlbHkuXG4gKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxUPn0gVGhlIGdlbmVyYXRlZCBzZXF1ZW5jZS5cbiAqL1xuICBleHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGU8VCwgUz4oaW5pdGlhbFN0YXRlOiBTLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uOiBDb25kaXRpb25GdW5jPFM+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0ZTogSXRlcmF0ZUZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTZWxlY3RvcjogUmVzdWx0RnVuYzxTLCBUPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlcj86IFNjaGVkdWxlckxpa2UpOiBPYnNlcnZhYmxlPFQ+O1xuXG4vKipcbiAqIEdlbmVyYXRlcyBhbiBPYnNlcnZhYmxlIGJ5IHJ1bm5pbmcgYSBzdGF0ZS1kcml2ZW4gbG9vcFxuICogdGhhdCBlbWl0cyBhbiBlbGVtZW50IG9uIGVhY2ggaXRlcmF0aW9uLlxuICpcbiAqIDxzcGFuIGNsYXNzPVwiaW5mb3JtYWxcIj5Vc2UgaXQgaW5zdGVhZCBvZiBuZXh0aW5nIHZhbHVlcyBpbiBhIGZvciBsb29wLjwvc3Bhbj5cbiAqXG4gKiA8aW1nIHNyYz1cIi4vaW1nL2dlbmVyYXRlLnBuZ1wiIHdpZHRoPVwiMTAwJVwiPlxuICpcbiAqIGBnZW5lcmF0ZWAgYWxsb3dzIHlvdSB0byBjcmVhdGUgc3RyZWFtIG9mIHZhbHVlcyBnZW5lcmF0ZWQgd2l0aCBhIGxvb3AgdmVyeSBzaW1pbGFyIHRvXG4gKiB0cmFkaXRpb25hbCBmb3IgbG9vcC4gRmlyc3QgYXJndW1lbnQgb2YgYGdlbmVyYXRlYCBpcyBhIGJlZ2lubmluZyB2YWx1ZS4gU2Vjb25kIGFyZ3VtZW50XG4gKiBpcyBhIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyB0aGlzIHZhbHVlIGFuZCB0ZXN0cyBpZiBzb21lIGNvbmRpdGlvbiBzdGlsbCBob2xkcy4gSWYgaXQgZG9lcyxcbiAqIGxvb3AgY29udGludWVzLCBpZiBub3QsIGl0IHN0b3BzLiBUaGlyZCB2YWx1ZSBpcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIHByZXZpb3VzbHkgZGVmaW5lZFxuICogdmFsdWUgYW5kIG1vZGlmaWVzIGl0IGluIHNvbWUgd2F5IG9uIGVhY2ggaXRlcmF0aW9uLiBOb3RlIGhvdyB0aGVzZSB0aHJlZSBwYXJhbWV0ZXJzXG4gKiBhcmUgZGlyZWN0IGVxdWl2YWxlbnRzIG9mIHRocmVlIGV4cHJlc3Npb25zIGluIHJlZ3VsYXIgZm9yIGxvb3A6IGZpcnN0IGV4cHJlc3Npb25cbiAqIGluaXRpYWxpemVzIHNvbWUgc3RhdGUgKGZvciBleGFtcGxlIG51bWVyaWMgaW5kZXgpLCBzZWNvbmQgdGVzdHMgaWYgbG9vcCBjYW4gbWFrZSBuZXh0XG4gKiBpdGVyYXRpb24gKGZvciBleGFtcGxlIGlmIGluZGV4IGlzIGxvd2VyIHRoYW4gMTApIGFuZCB0aGlyZCBzdGF0ZXMgaG93IGRlZmluZWQgdmFsdWVcbiAqIHdpbGwgYmUgbW9kaWZpZWQgb24gZXZlcnkgc3RlcCAoaW5kZXggd2lsbCBiZSBpbmNyZW1lbnRlZCBieSBvbmUpLlxuICpcbiAqIFJldHVybiB2YWx1ZSBvZiBhIGBnZW5lcmF0ZWAgb3BlcmF0b3IgaXMgYW4gT2JzZXJ2YWJsZSB0aGF0IG9uIGVhY2ggbG9vcCBpdGVyYXRpb25cbiAqIGVtaXRzIGEgdmFsdWUuIEZpcnN0LCBjb25kaXRpb24gZnVuY3Rpb24gaXMgcmFuLiBJZiBpdCByZXR1cm5lZCB0cnVlLCBPYnNlcnZhYmxlXG4gKiBlbWl0cyBjdXJyZW50bHkgc3RvcmVkIHZhbHVlIChpbml0aWFsIHZhbHVlIGF0IHRoZSBmaXJzdCBpdGVyYXRpb24pIGFuZCB0aGVuIHVwZGF0ZXNcbiAqIHRoYXQgdmFsdWUgd2l0aCBpdGVyYXRlIGZ1bmN0aW9uLiBJZiBhdCBzb21lIHBvaW50IGNvbmRpdGlvbiByZXR1cm5lZCBmYWxzZSwgT2JzZXJ2YWJsZVxuICogY29tcGxldGVzIGF0IHRoYXQgbW9tZW50LlxuICpcbiAqIE9wdGlvbmFsbHkgeW91IGNhbiBwYXNzIGZvdXJ0aCBwYXJhbWV0ZXIgdG8gYGdlbmVyYXRlYCAtIGEgcmVzdWx0IHNlbGVjdG9yIGZ1bmN0aW9uIHdoaWNoIGFsbG93cyB5b3VcbiAqIHRvIGltbWVkaWF0ZWx5IG1hcCB2YWx1ZSB0aGF0IHdvdWxkIG5vcm1hbGx5IGJlIGVtaXR0ZWQgYnkgYW4gT2JzZXJ2YWJsZS5cbiAqXG4gKiBJZiB5b3UgZmluZCB0aHJlZSBhbm9ueW1vdXMgZnVuY3Rpb25zIGluIGBnZW5lcmF0ZWAgY2FsbCBoYXJkIHRvIHJlYWQsIHlvdSBjYW4gcHJvdmlkZVxuICogc2luZ2xlIG9iamVjdCB0byB0aGUgb3BlcmF0b3IgaW5zdGVhZC4gVGhhdCBvYmplY3QgaGFzIHByb3BlcnRpZXM6IGBpbml0aWFsU3RhdGVgLFxuICogYGNvbmRpdGlvbmAsIGBpdGVyYXRlYCBhbmQgYHJlc3VsdFNlbGVjdG9yYCwgd2hpY2ggc2hvdWxkIGhhdmUgcmVzcGVjdGl2ZSB2YWx1ZXMgdGhhdCB5b3VcbiAqIHdvdWxkIG5vcm1hbGx5IHBhc3MgdG8gYGdlbmVyYXRlYC4gYHJlc3VsdFNlbGVjdG9yYCBpcyBzdGlsbCBvcHRpb25hbCwgYnV0IHRoYXQgZm9ybVxuICogb2YgY2FsbGluZyBgZ2VuZXJhdGVgIGFsbG93cyB5b3UgdG8gb21pdCBgY29uZGl0aW9uYCBhcyB3ZWxsLiBJZiB5b3Ugb21pdCBpdCwgdGhhdCBtZWFuc1xuICogY29uZGl0aW9uIGFsd2F5cyBob2xkcywgc28gb3V0cHV0IE9ic2VydmFibGUgd2lsbCBuZXZlciBjb21wbGV0ZS5cbiAqXG4gKiBCb3RoIGZvcm1zIG9mIGBnZW5lcmF0ZWAgY2FuIG9wdGlvbmFsbHkgYWNjZXB0IGEgc2NoZWR1bGVyLiBJbiBjYXNlIG9mIG11bHRpLXBhcmFtZXRlciBjYWxsLFxuICogc2NoZWR1bGVyIHNpbXBseSBjb21lcyBhcyBhIGxhc3QgYXJndW1lbnQgKG5vIG1hdHRlciBpZiB0aGVyZSBpcyByZXN1bHRTZWxlY3RvclxuICogZnVuY3Rpb24gb3Igbm90KS4gSW4gY2FzZSBvZiBzaW5nbGUtcGFyYW1ldGVyIGNhbGwsIHlvdSBjYW4gcHJvdmlkZSBpdCBhcyBhXG4gKiBgc2NoZWR1bGVyYCBwcm9wZXJ0eSBvbiBvYmplY3QgcGFzc2VkIHRvIHRoZSBvcGVyYXRvci4gSW4gYm90aCBjYXNlcyBzY2hlZHVsZXIgZGVjaWRlcyB3aGVuXG4gKiBuZXh0IGl0ZXJhdGlvbiBvZiB0aGUgbG9vcCB3aWxsIGhhcHBlbiBhbmQgdGhlcmVmb3JlIHdoZW4gbmV4dCB2YWx1ZSB3aWxsIGJlIGVtaXR0ZWRcbiAqIGJ5IHRoZSBPYnNlcnZhYmxlLiBGb3IgZXhhbXBsZSB0byBlbnN1cmUgdGhhdCBlYWNoIHZhbHVlIGlzIHB1c2hlZCB0byB0aGUgb2JzZXJ2ZXJcbiAqIG9uIHNlcGFyYXRlIHRhc2sgaW4gZXZlbnQgbG9vcCwgeW91IGNvdWxkIHVzZSBgYXN5bmNgIHNjaGVkdWxlci4gTm90ZSB0aGF0XG4gKiBieSBkZWZhdWx0ICh3aGVuIG5vIHNjaGVkdWxlciBpcyBwYXNzZWQpIHZhbHVlcyBhcmUgc2ltcGx5IGVtaXR0ZWQgc3luY2hyb25vdXNseS5cbiAqXG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+VXNlIHdpdGggY29uZGl0aW9uIGFuZCBpdGVyYXRlIGZ1bmN0aW9ucy48L2NhcHRpb24+XG4gKiBjb25zdCBnZW5lcmF0ZWQgPSBnZW5lcmF0ZSgwLCB4ID0+IHggPCAzLCB4ID0+IHggKyAxKTtcbiAqXG4gKiBnZW5lcmF0ZWQuc3Vic2NyaWJlKFxuICogICB2YWx1ZSA9PiBjb25zb2xlLmxvZyh2YWx1ZSksXG4gKiAgIGVyciA9PiB7fSxcbiAqICAgKCkgPT4gY29uc29sZS5sb2coJ1lvIScpXG4gKiApO1xuICpcbiAqIC8vIExvZ3M6XG4gKiAvLyAwXG4gKiAvLyAxXG4gKiAvLyAyXG4gKiAvLyBcIllvIVwiXG4gKlxuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPlVzZSB3aXRoIGNvbmRpdGlvbiwgaXRlcmF0ZSBhbmQgcmVzdWx0U2VsZWN0b3IgZnVuY3Rpb25zLjwvY2FwdGlvbj5cbiAqIGNvbnN0IGdlbmVyYXRlZCA9IGdlbmVyYXRlKDAsIHggPT4geCA8IDMsIHggPT4geCArIDEsIHggPT4geCAqIDEwMDApO1xuICpcbiAqIGdlbmVyYXRlZC5zdWJzY3JpYmUoXG4gKiAgIHZhbHVlID0+IGNvbnNvbGUubG9nKHZhbHVlKSxcbiAqICAgZXJyID0+IHt9LFxuICogICAoKSA9PiBjb25zb2xlLmxvZygnWW8hJylcbiAqICk7XG4gKlxuICogLy8gTG9nczpcbiAqIC8vIDBcbiAqIC8vIDEwMDBcbiAqIC8vIDIwMDBcbiAqIC8vIFwiWW8hXCJcbiAqXG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+VXNlIHdpdGggb3B0aW9ucyBvYmplY3QuPC9jYXB0aW9uPlxuICogY29uc3QgZ2VuZXJhdGVkID0gZ2VuZXJhdGUoe1xuICogICBpbml0aWFsU3RhdGU6IDAsXG4gKiAgIGNvbmRpdGlvbih2YWx1ZSkgeyByZXR1cm4gdmFsdWUgPCAzOyB9LFxuICogICBpdGVyYXRlKHZhbHVlKSB7IHJldHVybiB2YWx1ZSArIDE7IH0sXG4gKiAgIHJlc3VsdFNlbGVjdG9yKHZhbHVlKSB7IHJldHVybiB2YWx1ZSAqIDEwMDA7IH1cbiAqIH0pO1xuICpcbiAqIGdlbmVyYXRlZC5zdWJzY3JpYmUoXG4gKiAgIHZhbHVlID0+IGNvbnNvbGUubG9nKHZhbHVlKSxcbiAqICAgZXJyID0+IHt9LFxuICogICAoKSA9PiBjb25zb2xlLmxvZygnWW8hJylcbiAqICk7XG4gKlxuICogLy8gTG9nczpcbiAqIC8vIDBcbiAqIC8vIDEwMDBcbiAqIC8vIDIwMDBcbiAqIC8vIFwiWW8hXCJcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Vc2Ugb3B0aW9ucyBvYmplY3Qgd2l0aG91dCBjb25kaXRpb24gZnVuY3Rpb24uPC9jYXB0aW9uPlxuICogY29uc3QgZ2VuZXJhdGVkID0gZ2VuZXJhdGUoe1xuICogICBpbml0aWFsU3RhdGU6IDAsXG4gKiAgIGl0ZXJhdGUodmFsdWUpIHsgcmV0dXJuIHZhbHVlICsgMTsgfSxcbiAqICAgcmVzdWx0U2VsZWN0b3IodmFsdWUpIHsgcmV0dXJuIHZhbHVlICogMTAwMDsgfVxuICogfSk7XG4gKlxuICogZ2VuZXJhdGVkLnN1YnNjcmliZShcbiAqICAgdmFsdWUgPT4gY29uc29sZS5sb2codmFsdWUpLFxuICogICBlcnIgPT4ge30sXG4gKiAgICgpID0+IGNvbnNvbGUubG9nKCdZbyEnKSAvLyBUaGlzIHdpbGwgbmV2ZXIgcnVuLlxuICogKTtcbiAqXG4gKiAvLyBMb2dzOlxuICogLy8gMFxuICogLy8gMTAwMFxuICogLy8gMjAwMFxuICogLy8gMzAwMFxuICogLy8gLi4uYW5kIG5ldmVyIHN0b3BzLlxuICpcbiAqXG4gKiBAc2VlIHtAbGluayBmcm9tfVxuICogQHNlZSB7QGxpbmsgY3JlYXRlfVxuICpcbiAqIEBwYXJhbSB7U30gaW5pdGlhbFN0YXRlIEluaXRpYWwgc3RhdGUuXG4gKiBAcGFyYW0ge2Z1bmN0aW9uIChzdGF0ZTogUyk6IGJvb2xlYW59IGNvbmRpdGlvbiBDb25kaXRpb24gdG8gdGVybWluYXRlIGdlbmVyYXRpb24gKHVwb24gcmV0dXJuaW5nIGZhbHNlKS5cbiAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogU30gaXRlcmF0ZSBJdGVyYXRpb24gc3RlcCBmdW5jdGlvbi5cbiAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogVH0gW3Jlc3VsdFNlbGVjdG9yXSBTZWxlY3RvciBmdW5jdGlvbiBmb3IgcmVzdWx0cyBwcm9kdWNlZCBpbiB0aGUgc2VxdWVuY2UuXG4gKiBAcGFyYW0ge1NjaGVkdWxlcn0gW3NjaGVkdWxlcl0gQSB7QGxpbmsgU2NoZWR1bGVyfSBvbiB3aGljaCB0byBydW4gdGhlIGdlbmVyYXRvciBsb29wLiBJZiBub3QgcHJvdmlkZWQsIGRlZmF1bHRzIHRvIGVtaXR0aW5nIGltbWVkaWF0ZWx5LlxuICogQHJldHVybiB7T2JzZXJ2YWJsZTxUPn0gVGhlIGdlbmVyYXRlZCBzZXF1ZW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlPFM+KGluaXRpYWxTdGF0ZTogUyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IENvbmRpdGlvbkZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0ZTogSXRlcmF0ZUZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9ic2VydmFibGU8Uz47XG5cbi8qKlxuICogR2VuZXJhdGVzIGFuIG9ic2VydmFibGUgc2VxdWVuY2UgYnkgcnVubmluZyBhIHN0YXRlLWRyaXZlbiBsb29wXG4gKiBwcm9kdWNpbmcgdGhlIHNlcXVlbmNlJ3MgZWxlbWVudHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQgc2NoZWR1bGVyXG4gKiB0byBzZW5kIG91dCBvYnNlcnZlciBtZXNzYWdlcy5cbiAqIFRoZSBvdmVybG9hZCBhY2NlcHRzIG9wdGlvbnMgb2JqZWN0IHRoYXQgbWlnaHQgY29udGFpbiBpbml0aWFsIHN0YXRlLCBpdGVyYXRlLFxuICogY29uZGl0aW9uIGFuZCBzY2hlZHVsZXIuXG4gKlxuICogIVtdKGdlbmVyYXRlLnBuZylcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Qcm9kdWNlcyBzZXF1ZW5jZSBvZiAwLCAxLCAyLCAuLi4gOSwgdGhlbiBjb21wbGV0ZXMuPC9jYXB0aW9uPlxuICogY29uc3QgcmVzID0gZ2VuZXJhdGUoe1xuICogICBpbml0aWFsU3RhdGU6IDAsXG4gKiAgIGNvbmRpdGlvbjogeCA9PiB4IDwgMTAsXG4gKiAgIGl0ZXJhdGU6IHggPT4geCArIDEsXG4gKiB9KTtcbiAqXG4gKiBAc2VlIHtAbGluayBmcm9tfVxuICogQHNlZSB7QGxpbmsgT2JzZXJ2YWJsZX1cbiAqXG4gKiBAcGFyYW0ge0dlbmVyYXRlQmFzZU9wdGlvbnM8Uz59IG9wdGlvbnMgT2JqZWN0IHRoYXQgbXVzdCBjb250YWluIGluaXRpYWxTdGF0ZSwgaXRlcmF0ZSBhbmQgbWlnaHQgY29udGFpbiBjb25kaXRpb24gYW5kIHNjaGVkdWxlci5cbiAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPFM+fSBUaGUgZ2VuZXJhdGVkIHNlcXVlbmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGU8Uz4ob3B0aW9uczogR2VuZXJhdGVCYXNlT3B0aW9uczxTPik6IE9ic2VydmFibGU8Uz47XG5cbi8qKlxuICogR2VuZXJhdGVzIGFuIG9ic2VydmFibGUgc2VxdWVuY2UgYnkgcnVubmluZyBhIHN0YXRlLWRyaXZlbiBsb29wXG4gKiBwcm9kdWNpbmcgdGhlIHNlcXVlbmNlJ3MgZWxlbWVudHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQgc2NoZWR1bGVyXG4gKiB0byBzZW5kIG91dCBvYnNlcnZlciBtZXNzYWdlcy5cbiAqIFRoZSBvdmVybG9hZCBhY2NlcHRzIG9wdGlvbnMgb2JqZWN0IHRoYXQgbWlnaHQgY29udGFpbiBpbml0aWFsIHN0YXRlLCBpdGVyYXRlLFxuICogY29uZGl0aW9uLCByZXN1bHQgc2VsZWN0b3IgYW5kIHNjaGVkdWxlci5cbiAqXG4gKiAhW10oZ2VuZXJhdGUucG5nKVxuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPlByb2R1Y2VzIHNlcXVlbmNlIG9mIDAsIDEsIDIsIC4uLiA5LCB0aGVuIGNvbXBsZXRlcy48L2NhcHRpb24+XG4gKiBjb25zdCByZXMgPSBnZW5lcmF0ZSh7XG4gKiAgIGluaXRpYWxTdGF0ZTogMCxcbiAqICAgY29uZGl0aW9uOiB4ID0+IHggPCAxMCxcbiAqICAgaXRlcmF0ZTogeCA9PiB4ICsgMSxcbiAqICAgcmVzdWx0U2VsZWN0b3I6IHggPT4geCxcbiAqIH0pO1xuICpcbiAqIEBzZWUge0BsaW5rIGZyb219XG4gKiBAc2VlIHtAbGluayBPYnNlcnZhYmxlfVxuICpcbiAqIEBwYXJhbSB7R2VuZXJhdGVPcHRpb25zPFQsIFM+fSBvcHRpb25zIE9iamVjdCB0aGF0IG11c3QgY29udGFpbiBpbml0aWFsU3RhdGUsIGl0ZXJhdGUsIHJlc3VsdFNlbGVjdG9yIGFuZCBtaWdodCBjb250YWluIGNvbmRpdGlvbiBhbmQgc2NoZWR1bGVyLlxuICogQHJldHVybnMge09ic2VydmFibGU8VD59IFRoZSBnZW5lcmF0ZWQgc2VxdWVuY2UuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZTxULCBTPihvcHRpb25zOiBHZW5lcmF0ZU9wdGlvbnM8VCwgUz4pOiBPYnNlcnZhYmxlPFQ+O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGU8VCwgUz4oaW5pdGlhbFN0YXRlT3JPcHRpb25zOiBTIHwgR2VuZXJhdGVPcHRpb25zPFQsIFM+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbj86IENvbmRpdGlvbkZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlcmF0ZT86IEl0ZXJhdGVGdW5jPFM+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlPzogKFJlc3VsdEZ1bmM8UywgVD4pIHwgU2NoZWR1bGVyTGlrZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXI/OiBTY2hlZHVsZXJMaWtlKTogT2JzZXJ2YWJsZTxUPiB7XG5cbiAgbGV0IHJlc3VsdFNlbGVjdG9yOiBSZXN1bHRGdW5jPFMsIFQ+O1xuICBsZXQgaW5pdGlhbFN0YXRlOiBTO1xuXG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHtcbiAgICBjb25zdCBvcHRpb25zID0gaW5pdGlhbFN0YXRlT3JPcHRpb25zIGFzIEdlbmVyYXRlT3B0aW9uczxULCBTPjtcbiAgICBpbml0aWFsU3RhdGUgPSBvcHRpb25zLmluaXRpYWxTdGF0ZTtcbiAgICBjb25kaXRpb24gPSBvcHRpb25zLmNvbmRpdGlvbjtcbiAgICBpdGVyYXRlID0gb3B0aW9ucy5pdGVyYXRlO1xuICAgIHJlc3VsdFNlbGVjdG9yID0gb3B0aW9ucy5yZXN1bHRTZWxlY3RvciB8fCBpZGVudGl0eSBhcyBSZXN1bHRGdW5jPFMsIFQ+O1xuICAgIHNjaGVkdWxlciA9IG9wdGlvbnMuc2NoZWR1bGVyO1xuICB9IGVsc2UgaWYgKHJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlID09PSB1bmRlZmluZWQgfHwgaXNTY2hlZHVsZXIocmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGUpKSB7XG4gICAgaW5pdGlhbFN0YXRlID0gaW5pdGlhbFN0YXRlT3JPcHRpb25zIGFzIFM7XG4gICAgcmVzdWx0U2VsZWN0b3IgPSBpZGVudGl0eSBhcyBSZXN1bHRGdW5jPFMsIFQ+O1xuICAgIHNjaGVkdWxlciA9IHJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlIGFzIFNjaGVkdWxlckxpa2U7XG4gIH0gZWxzZSB7XG4gICAgaW5pdGlhbFN0YXRlID0gaW5pdGlhbFN0YXRlT3JPcHRpb25zIGFzIFM7XG4gICAgcmVzdWx0U2VsZWN0b3IgPSByZXN1bHRTZWxlY3Rvck9yT2JzZXJ2YWJsZSBhcyBSZXN1bHRGdW5jPFMsIFQ+O1xuICB9XG5cbiAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICAgIGxldCBzdGF0ZSA9IGluaXRpYWxTdGF0ZTtcbiAgICBpZiAoc2NoZWR1bGVyKSB7XG4gICAgICByZXR1cm4gc2NoZWR1bGVyLnNjaGVkdWxlPFNjaGVkdWxlclN0YXRlPFQsIFM+PihkaXNwYXRjaCwgMCwge1xuICAgICAgICBzdWJzY3JpYmVyLFxuICAgICAgICBpdGVyYXRlLFxuICAgICAgICBjb25kaXRpb24sXG4gICAgICAgIHJlc3VsdFNlbGVjdG9yLFxuICAgICAgICBzdGF0ZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZG8ge1xuICAgICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgICBsZXQgY29uZGl0aW9uUmVzdWx0OiBib29sZWFuO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbmRpdGlvblJlc3VsdCA9IGNvbmRpdGlvbihzdGF0ZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGlmICghY29uZGl0aW9uUmVzdWx0KSB7XG4gICAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXQgdmFsdWU6IFQ7XG4gICAgICB0cnkge1xuICAgICAgICB2YWx1ZSA9IHJlc3VsdFNlbGVjdG9yKHN0YXRlKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBzdWJzY3JpYmVyLm5leHQodmFsdWUpO1xuICAgICAgaWYgKHN1YnNjcmliZXIuY2xvc2VkKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgc3RhdGUgPSBpdGVyYXRlKHN0YXRlKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfSB3aGlsZSAodHJ1ZSk7XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZGlzcGF0Y2g8VCwgUz4odGhpczogU2NoZWR1bGVyQWN0aW9uPFNjaGVkdWxlclN0YXRlPFQsIFM+Piwgc3RhdGU6IFNjaGVkdWxlclN0YXRlPFQsIFM+KSB7XG4gIGNvbnN0IHsgc3Vic2NyaWJlciwgY29uZGl0aW9uIH0gPSBzdGF0ZTtcbiAgaWYgKHN1YnNjcmliZXIuY2xvc2VkKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBpZiAoc3RhdGUubmVlZEl0ZXJhdGUpIHtcbiAgICB0cnkge1xuICAgICAgc3RhdGUuc3RhdGUgPSBzdGF0ZS5pdGVyYXRlKHN0YXRlLnN0YXRlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHN0YXRlLm5lZWRJdGVyYXRlID0gdHJ1ZTtcbiAgfVxuICBpZiAoY29uZGl0aW9uKSB7XG4gICAgbGV0IGNvbmRpdGlvblJlc3VsdDogYm9vbGVhbjtcbiAgICB0cnkge1xuICAgICAgY29uZGl0aW9uUmVzdWx0ID0gY29uZGl0aW9uKHN0YXRlLnN0YXRlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmICghY29uZGl0aW9uUmVzdWx0KSB7XG4gICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG4gIGxldCB2YWx1ZTogVDtcbiAgdHJ5IHtcbiAgICB2YWx1ZSA9IHN0YXRlLnJlc3VsdFNlbGVjdG9yKHN0YXRlLnN0YXRlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgaWYgKHN1YnNjcmliZXIuY2xvc2VkKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBzdWJzY3JpYmVyLm5leHQodmFsdWUpO1xuICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIHJldHVybiB0aGlzLnNjaGVkdWxlKHN0YXRlKTtcbn1cbiJdfQ==